---
layout: blog
title: 队列分析【draft】
categories: [cate1, cate2]
description: some word here
keywords: keyword1, keyword2
cnblogsClass: \[Markdown\],\[随笔分类\]服务器,\[随笔分类\]架构,\[随笔分类\]网络协议,\[发布为文章\]
oschinaClass: \[Markdown\],服务器,日常记录
csdnClass: \[Markdown\]
163Class: \[Markdown\]
51ctoClass: \[Markdown\]
chinaunixClass: \[Markdown\]
sinaClass: \[Markdown\]
---

<!--
title内容带draft标识草稿

cnblogsClass: 【你的博客园的分类，以逗号分隔，注意\[Markdown\]必须项】
oschinaClass: 【你的开源中国的分类】
csdnClass: 【你的CSDN分类】
...

注：由于'['、']'是jekyll的关键字，故在分类中请加上'\'；

可以在网站下添加操作看到你的博客分类，案列是自己的分类，需要自行修改。
添加这些分类的目的，是可以自动同步到对应的博客网站，新建博客以此模版文件复制创建markdown文件，如果你不需要，请跳过此步。


图片地址存放参考：
本地存放路径/WindBlog/gh-pages/images/blog/b.png
git上：
![image](https://raw.githubusercontent.com/WalkingSun/WindBlog/gh-pages/images/blog/b.png)

-->

# 了解协议 AMQP
https://baike.baidu.com/item/AMQP/8354716?fr=aladdin

# 了解队列

## 应用场景

https://www.cnblogs.com/jajian/p/10257555.html

[https://mp.weixin.qq.com/s?__biz=MzU0OTk3ODQ3Ng==&mid=2247484149&idx=1&sn=98186297335e13ec7222b3fd43cfae5a&chksm=fba6eaf6ccd163e0c2c3086daa725de224a97814d31e7b3f62dd3ec763b4abbb0689cc7565b0&scene=21#wechat_redirect](https://mp.weixin.qq.com/s?__biz=MzU0OTk3ODQ3Ng==&mid=2247484149&idx=1&sn=98186297335e13ec7222b3fd43cfae5a&chksm=fba6eaf6ccd163e0c2c3086daa725de224a97814d31e7b3f62dd3ec763b4abbb0689cc7565b0&scene=21#wechat_redirect
)
- 复杂系统的解耦
系统A产生核心数据需要同步成百个系统，由队列路由转发就可以了。

- 复杂链路的异步调用

- 瞬时高峰的削峰处理

 RabbitMQ基础知识    [https://www.cnblogs.com/dwlsxj/p/RabbitMQ.html](https://www.cnblogs.com/dwlsxj/p/RabbitMQ.html)

参考： https://segmentfault.com/a/1190000012016574

https://www.cnblogs.com/oskyhg/p/8521705.html

RabbitMQ持久化消息
RabbitMQ实现持久化消息需满足以下3个条件：

delivery_mode=2
使用durable=True声明exchange是持久化
使用durable=True声明queue是持久化

delivery_mode
delivery_mode=2指明message为持久的.
delivery_mode 投递消息模式
1 . ram
2 . disc
设置为disc后能从AMQP服务器崩溃中恢复消息--持久化
但效率比 ram:disc = 3:1
durable
durable （默认false）
rabbitmq重启后queue和Exchange会被清除，包括数据。

basic.qos函数来进行流量控制：$channel->basic_qos(null, 1, null); 第二个参数prefetch_count来控制每次消费数量。

代码参考：https://github.com/WalkingSun/Jump/blob/master/commands/RabbitmqController.php

各大队列使用优缺：
- RabbitMQ的开源社区很活跃，较高频率的迭代版本，来修复发现的bug以及进行各种优化，因此综合考虑过后，公司采取了RabbitMQ
- Kafka的优势在于专为超高吞吐量的实时日志采集、实时数据同步、实时数据计算等场景来设计
- RocketMQ是基于Java语言开发的，适合深入阅读源码，有需要可以站在源码层面解决线上生产问题，包括源码的二次开发和改造。

![image](https://raw.githubusercontent.com/WalkingSun/WindBlog/gh-pages/images/blog/clipboard.png)

持久化
[持久化](https://mp.weixin.qq.com/s?__biz=MzU0OTk3ODQ3Ng==&mid=2247484257&idx=1&sn=e7704f92a1008ab7a292e2826bd079aa&chksm=fba6eb62ccd1627451d439bbc21e46e6fc1d7bfbe2a431fd887cf974a7bd0d9d482697f0e4fd&scene=21)

ack 业务消费服务器收到队列消息宕机，队列系统已经删了数据，如果是减库存的操作，这个单子就会被遗漏，丢失

[https://mp.weixin.qq.com/s?__biz=MzU0OTk3ODQ3Ng==&mid=2247484204&idx=1&sn=6fc43b0620857b653dbef20693d1c6c6&chksm=fba6eb2fccd16239056e4b52dc0895585292b830bfd2652dea81b7360556fe36aceac0951761&scene=21](https://mp.weixin.qq.com/s?__biz=MzU0OTk3ODQ3Ng==&mid=2247484204&idx=1&sn=6fc43b0620857b653dbef20693d1c6c6&chksm=fba6eb2fccd16239056e4b52dc0895585292b830bfd2652dea81b7360556fe36aceac0951761&scene=21)