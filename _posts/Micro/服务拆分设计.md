# 为何拆分微服务

结合实际生产存在问题：新功能叠加，项目间模块的界限很难明确；代码越来越臃肿，代码耦合维护更加困难，职责不清晰，改一个地方可能涉及跨项目模块的修改；开发整理旧逻辑比较费力，如果疏漏逻辑会带来一定的安全隐患。

单体架构拆分成多个独立的业务模块，

单一职责：“把因相同原因而变化的东西聚合到一起，而把因不同原因而变化的东西分离开来。” （Robert C. Martin对单一职责原则（SingleResponsibility Principle,http://programmer.97things.oreilly.com/wiki/index.php/ The SingleResponsibility Principle）的论述）

RPC：在分布式计算，远程过程调用（英语：Remote Procedure Call，缩写为 RPC）是一个计算机通信协议。该协议允许运行于一台计算机的程序调用另一个地址空间（通常为一个开放网络的一台计算机）的子程序，而程序员就像调用本地程序一样，无需额外地为这个交互作用编程（无需关注细节）。RPC是一种服务器-客户端（Client/Server）模式，经典实现是一个通过发送请求-接受回应进行信息交互的系统。


# 微服务
微服务概念：服务粒度更细，职责更加清晰，高内聚低耦合，微服务专注做好一件事，可扩展，持续交付（采取自动化测试、持续集成、自动化部署等快速交付），敏捷快速迭代。

微服务拆分目的：对业务领域进行拆分，分而治之降低系统的复杂性和可维护性，解耦业务，项目间的职责更加明确，方便维护扩展。
  
微服务拆分规范：
  拆分：  
1. 梳理当前各项目的业务模块（当前项目按照垂直拆分粒度比较大的服务），梳理耦合部分业务逻辑，保证各个服务职责明确。
2. 基于当前移动联盟业务梳理进行业务、可扩展、可靠性拆分：
  - 业务拆分：系统中的业务模块按照职责范围识别出来，每个单独的业务模块拆分为一个独立的服务；
  - 可扩展拆分：将系统中的业务模块按照稳定性排序，将已经成熟和改动不大的服务拆分为稳定服务，将经常变化和迭代的服务拆分为变动服务；
  - 可靠性拆分：将系统中的业务模块按照优先级排序，将可靠性要求高的核心服务和可靠性要求低的非核心服务拆分开来，然后重点保证核心服务的高可用。我理解比如k8s点击的ingress、pod隔离；
3. 两者结合，首先按当前拆分项目整合职责，后考虑把比较独立的相关业务抽离出来；

## 梳理项目模块耦合部分（高内聚低耦合）

![20210914164614](https://i.loli.net/2021/09/14/ResHjME95XwmnFy.png)

## 正交原则（相互依赖性）
正交原则：「正交」是一个数学概念：所谓正交，就是指两个向量的内积为零。简单的说，就是这两个向量是垂直的。在一个正交系统里，沿着一个方向的变化，其另外一个方向不会发生变化。

正交设计原则
- 消除重复

- 分离关注点

- 缩小依赖范围

- 向稳定的方向依赖

![20210914160612](https://i.loli.net/2021/09/14/3LQMoiI8Vh2HRJD.png)


## 实施
微服务不是银弹，一下子切成微服务首先开发时间成本高，其次开发阶段会导致业务停滞，然后上线切换，新系统问题会多。早期还是运用微服务拆分的理念来约束项目服务边界，使用gRPC来进行RPC调用，来降低项目间的耦合性，后面在考虑某块业务拆分。

### 项目工程化-目录结构规范：
```shell
- micro // 服务
  - cmd
   └── service // 对内的微服务，仅接受来自内部其他服务或者网关的请求，比如暴露了 gRPC 接口只对内服务。
       └── group.go // 如提供对内的渠道组服务
   └── api   // 对外暴露服务，接受来自用户的请求，比如暴露了 HTTP/gRPC 接口  
   └── job         // 流式任务处理的服务。
   └── cron   // 定时任务
   └── main.go
  - api  // API 定义的目录，使用 grpc 存放 proto 文件及生成代码文件
   └── product_name // 产品名称，如推广分析-渠道管理
        └── app_name // 应用名称，如渠道组
#            └── v1   // 版本号
                └── group.proto
                └── group_pb.go
                └── group_grpc_pb.go
                └── client.go             // 客户端指定连接方式
                └── README.md       // 使用说明，如跨语言PHP如何接入
 - pkg 
  └── service         // 逻辑层
  └── repository    // 数据处理层
```

/pkg 一般而言，我们在 pkg 目录下放置可以被外部程序安全导入的包
/internal 不应该被外部程序依赖的包我们应该放置到 internal 目录下， internal 目录会有编译器进行强制验证

### proto规范
对内服务，如
```protocol
syntax = "proto3";

package group;

option go_package = "./api/channel-manage/group";

service Group {
  rpc GetAccountList (GroupRequest) returns (GroupReply)  {}
}

message GroupRequest {
  string Source  = 1;
  string AccountIDs =2;
}

message GroupInfo {
  int64 ID = 1;
  string Source  = 2;
  string AccountID =3;
}

message GroupReply {
  repeated GroupInfo  GroupInfo = 1;
}
```

- [ ] 内部调用 stat
解决包引用问题，版本管理问题？
  - 代码指定版本目录
  - sub module
  - api层抽成单独库

- [ ] php调用实例

- [ ] 渠道管理微服务拆分图示，耦合部分
- [ ] 自动部署，解决部署问题，服务越来越多怎么管理

### grpc调试



微服务接口规范：
- 内部调用
  - rpc接口定义规范：proto文件
- 对外 http:restful风格

- 全局状态码设置
  - 多个服务返回值规范
  - http状态码

微服务间调用使用RPC协议，RPC服务协议
- http
- http2
- grpc
- socket

渠道管理拆分服务：
- 结算账户查询














微服务框架：
- go micro
- go kit


注意点
- [ ] 将应用完全按微服务架构重新开发，首先时间成本比较高，其次测试比较困难，而且会导致某些业务长期时间是停滞的，上线之后问题比较多，这将是噩梦；
- [ ] 微服务迁移需要一点点推进，满足现有业务发展；
- [ ] 项目工程化规范：
  - proto文件及序列化、grpc接口文件存放目录
  - 对外服务目录格式
  - 对内服务目录格式
- [ ] gRPC调试 
  - gocurl: https://www.cnblogs.com/52fhy/p/12376940.html
- [ ] 依赖注入


参考：
https://zhuanlan.zhihu.com/p/333393446
[正交设计](https://segmentfault.com/a/1190000004552525)

[RPC](https://zh.wikipedia.org/wiki/%E9%81%A0%E7%A8%8B%E9%81%8E%E7%A8%8B%E8%AA%BF%E7%94%A8)

[Go工程化-项目目录结构](https://lailin.xyz/post/go-training-week4-project-layout.html)

[grpc调试](https://tech.qimao.com/grpc/)

[sub moduke](https://git-reference.readthedocs.io/zh_CN/latest/Git-Tools/Submodules/)

[grpc PHP](https://grpc.io/docs/languages/php/quickstart/)


https://pear.php.net/manual/en/installation.getting.php

https://pear.php.net/manual/en/installation.checking.php

brew install autoconf

Question：
/private/tmp/pear/install/grpc/src/php/ext/grpc/byte_buffer.c:19:10: fatal error: 'php.h' file not found
#include <php.h>
         ^~~~~~~
1 error generated.
make: *** [src/php/ext/grpc/byte_buffer.lo] Error 1
ERROR: `make' failed

https://segmentfault.com/a/1190000019234926

composer2.0 https://blog.packagist.com/composer-2-0-is-now-available/

https://www.imooc.com/wenda/detail/561163